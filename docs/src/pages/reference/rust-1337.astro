---
import Base from '../../layouts/Base.astro';
---

<Base title="rust-1337" description="rust development decisions">
  <p><a href="/claude-1337/reference/">&larr; reference</a></p>

  <p>production-grade patterns that separate competent from exceptional rust developers</p>

  <h2>install</h2>

  <pre><code>/plugin install rust-1337@claude-1337</code></pre>

  <h2>philosophy</h2>

  <ol>
    <li><strong>make illegal states unrepresentable</strong> — use types to eliminate bugs</li>
    <li><strong>parse, don't validate</strong> — transform unstructured data into typed structures</li>
    <li><strong>zero-cost abstractions</strong> — high-level code that compiles to optimal machine code</li>
    <li><strong>explicit over implicit</strong> — no hidden allocations, no surprise behavior</li>
    <li><strong>design away lifetime complexity</strong> — if fighting borrow checker, reconsider data model</li>
  </ol>

  <h2>decision frameworks</h2>

  <h3>string ownership (95% rule)</h3>

  <table>
    <tr>
      <th>context</th>
      <th>use</th>
      <th>why</th>
    </tr>
    <tr>
      <td>struct fields</td>
      <td>String</td>
      <td>owned data lives with struct</td>
    </tr>
    <tr>
      <td>function params</td>
      <td>&amp;str</td>
      <td>accept any string via deref</td>
    </tr>
    <tr>
      <td>return (from input)</td>
      <td>&amp;str</td>
      <td>zero-cost slice</td>
    </tr>
    <tr>
      <td>return (newly created)</td>
      <td>String</td>
      <td>caller needs ownership</td>
    </tr>
    <tr>
      <td>conditional modification</td>
      <td>Cow&lt;'_, str&gt;</td>
      <td>clone-on-write</td>
    </tr>
  </table>

  <h3>error handling</h3>

  <pre><code>Writing a library?
├── YES → thiserror (callers match on variants)
└── NO (application) → Need pretty diagnostics?
    ├── YES → color-eyre (CLI) or miette (source snippets)
    └── NO → anyhow</code></pre>

  <h3>async vs threads</h3>

  <table>
    <tr>
      <th>workload</th>
      <th>choice</th>
      <th>rule</th>
    </tr>
    <tr>
      <td>CPU-bound</td>
      <td>threads / spawn_blocking</td>
      <td>never block async workers</td>
    </tr>
    <tr>
      <td>high-concurrency I/O</td>
      <td>async</td>
      <td>scales to millions</td>
    </tr>
    <tr>
      <td>simple concurrency</td>
      <td>threads</td>
      <td>avoid async complexity</td>
    </tr>
  </table>

  <p><strong>critical:</strong> no more than 10-100µs between .await points</p>

  <h2>production gotchas</h2>

  <h3>blocking in async</h3>

  <p><strong>trap:</strong> sync operations inside async tasks starve runtime</p>
  <p><strong>fix:</strong> spawn_blocking() for CPU work; async alternatives for I/O</p>

  <pre><code>// wrong
async fn bad() {"{"} std::thread::sleep(Duration::from_secs(2)); {"}"}

// correct
async fn good() {"{"} tokio::task::spawn_blocking(|| heavy_computation()).await.unwrap(); {"}"}</code></pre>

  <h3>mutex across await</h3>

  <p><strong>trap:</strong> std::sync::Mutex guard held across .await deadlocks</p>
  <p><strong>fix:</strong> drop guard before await, or tokio::sync::Mutex</p>

  <pre><code>// deadlock risk
async fn bad(mutex: Arc&lt;std::sync::Mutex&lt;i32&gt;&gt;) {"{"}
    let guard = mutex.lock().unwrap();
    some_async_op().await; // guard held!
{"}"}

// safe: explicit drop
async fn good(mutex: Arc&lt;std::sync::Mutex&lt;i32&gt;&gt;) {"{"}
    {"{"}
        let mut guard = mutex.lock().unwrap();
        *guard += 1;
    {"}"} // dropped before await
    some_async_op().await;
{"}"}</code></pre>

  <h3>cancellation safety</h3>

  <p><strong>trap:</strong> futures dropped mid-operation leave invalid state</p>
  <p><strong>detection:</strong> check API docs; read is safe, read_line is NOT</p>

  <h2>obsolete patterns</h2>

  <table>
    <tr>
      <th>obsolete</th>
      <th>replacement</th>
      <th>since</th>
    </tr>
    <tr>
      <td>lazy_static!</td>
      <td>std::sync::LazyLock</td>
      <td>rust 1.80</td>
    </tr>
    <tr>
      <td>once_cell (most uses)</td>
      <td>std::sync::OnceLock</td>
      <td>rust 1.70</td>
    </tr>
    <tr>
      <td>async-std</td>
      <td>smol (or tokio)</td>
      <td>march 2025</td>
    </tr>
    <tr>
      <td>structopt</td>
      <td>clap v4 derive</td>
      <td>clap 3.0</td>
    </tr>
    <tr>
      <td>async-trait (some)</td>
      <td>native async fn in traits</td>
      <td>rust 1.75</td>
    </tr>
    <tr>
      <td>async closure workarounds</td>
      <td>native async || {"{}"} closures</td>
      <td>rust 1.85</td>
    </tr>
  </table>

  <h2>common crates</h2>

  <table>
    <tr>
      <th>need</th>
      <th>crate</th>
    </tr>
    <tr>
      <td>errors (lib)</td>
      <td>thiserror</td>
    </tr>
    <tr>
      <td>errors (app)</td>
      <td>anyhow</td>
    </tr>
    <tr>
      <td>serialization</td>
      <td>serde, serde_json, toml</td>
    </tr>
    <tr>
      <td>CLI</td>
      <td>clap (or lexopt for minimal)</td>
    </tr>
    <tr>
      <td>async</td>
      <td>tokio</td>
    </tr>
    <tr>
      <td>http client</td>
      <td>reqwest</td>
    </tr>
    <tr>
      <td>http server</td>
      <td>axum</td>
    </tr>
    <tr>
      <td>logging</td>
      <td>tracing</td>
    </tr>
    <tr>
      <td>testing</td>
      <td>proptest, nextest, insta</td>
    </tr>
  </table>

  <h2>specialized domains</h2>

  <p>the skill routes to specific references based on project context:</p>

  <table>
    <tr>
      <th>detected</th>
      <th>loads</th>
    </tr>
    <tr>
      <td>clap, lexopt, CLI binary</td>
      <td>cli.md</td>
    </tr>
    <tr>
      <td>axum, tonic, sqlx</td>
      <td>backend.md</td>
    </tr>
    <tr>
      <td>leptos, dioxus, wasm-bindgen</td>
      <td>frontend.md</td>
    </tr>
    <tr>
      <td>tauri, egui</td>
      <td>native.md</td>
    </tr>
    <tr>
      <td>#![no_std], cortex-m, embassy</td>
      <td>embedded.md</td>
    </tr>
    <tr>
      <td>pingora, rama, proxy</td>
      <td>data-plane.md</td>
    </tr>
    <tr>
      <td>bindgen, cxx, PyO3, unsafe</td>
      <td>ffi-unsafe.md</td>
    </tr>
    <tr>
      <td>proc-macro = true, syn, quote</td>
      <td>proc-macros.md</td>
    </tr>
    <tr>
      <td>reqwest, HTTP client</td>
      <td>networking.md</td>
    </tr>
    <tr>
      <td>project setup, CI</td>
      <td>tooling.md</td>
    </tr>
    <tr>
      <td>deep async patterns</td>
      <td>async.md</td>
    </tr>
  </table>

  <h2>structure</h2>

  <pre><code>plugins/rust-1337/
├── SKILL.md              # core patterns, decision frameworks
├── references/           # 12 specialized domain files
│   ├── cli.md
│   ├── backend.md
│   ├── frontend.md
│   ├── native.md
│   ├── embedded.md
│   ├── data-plane.md
│   ├── ffi-unsafe.md
│   ├── proc-macros.md
│   ├── networking.md
│   ├── ecosystem.md
│   ├── tooling.md
│   └── async.md
└── hooks/
    └── skill-eval.sh     # activation fix</code></pre>
</Base>
