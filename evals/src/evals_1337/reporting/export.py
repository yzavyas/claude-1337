"""Export utilities for eval results.

Export to JSON, CSV, and Markdown formats.
"""

import json
from datetime import datetime
from pathlib import Path
from typing import Any

import pandas as pd

from ..core.models import EvalReport


def export_json(report: EvalReport, path: Path | str) -> None:
    """Export report to JSON file."""
    path = Path(path)

    data = {
        "name": report.name,
        "target_type": report.target_type,
        "timestamp": report.timestamp.isoformat(),
        "config": report.config,
        "summary": report.summary(),
        "results": [
            {
                "prompt": r.test_case.prompt,
                "expectation": r.test_case.expectation.value,
                "rationale": r.test_case.rationale,
                "passed": r.passed,
                "outcome": r.outcome.value,
                "duration_ms": r.duration_ms,
                "details": r.details,
                "error": r.error,
                "timestamp": r.timestamp.isoformat(),
            }
            for r in report.results
        ],
    }

    with open(path, "w") as f:
        json.dump(data, f, indent=2)


def export_csv(report: EvalReport, path: Path | str) -> None:
    """Export report results to CSV file."""
    path = Path(path)

    rows = []
    for r in report.results:
        row = {
            "prompt": r.test_case.prompt,
            "expectation": r.test_case.expectation.value,
            "passed": r.passed,
            "outcome": r.outcome.value,
            "duration_ms": r.duration_ms,
            "error": r.error or "",
        }
        # Flatten common details
        for k in ["target_skill", "skills_activated", "mode", "runtime"]:
            if k in r.details:
                val = r.details[k]
                row[k] = ", ".join(val) if isinstance(val, list) else val
        rows.append(row)

    df = pd.DataFrame(rows)
    df.to_csv(path, index=False)


def export_markdown(report: EvalReport, path: Path | str) -> None:
    """Export report to Markdown file."""
    path = Path(path)
    metrics = report.metrics()

    lines = [
        f"# Eval Report: {report.name}",
        "",
        f"**Type:** {report.target_type}",
        f"**Date:** {report.timestamp.strftime('%Y-%m-%d %H:%M')}",
        "",
        "## Summary",
        "",
        f"| Metric | Value |",
        f"|--------|-------|",
        f"| Precision | {metrics.precision:.1%} |",
        f"| Recall | {metrics.recall:.1%} |",
        f"| F1 | {metrics.f1:.1%} |",
        f"| Accuracy | {metrics.accuracy:.1%} |",
        "",
        "## Confusion Matrix",
        "",
        "```",
        f"                ACTUAL",
        f"                Pass    Fail",
        f"            +--------+--------+",
        f"EXPECTED  P |  {metrics.tp:4d}  |  {metrics.fn:4d}  |",
        f"            +--------+--------+",
        f"          F |  {metrics.fp:4d}  |  {metrics.tn:4d}  |",
        f"            +--------+--------+",
        "```",
        "",
        "## Results",
        "",
        "| Prompt | Expected | Outcome |",
        "|--------|----------|---------|",
    ]

    for r in report.results[:20]:  # Limit to 20
        prompt = r.test_case.prompt[:40].replace("|", "\\|")
        if len(r.test_case.prompt) > 40:
            prompt += "..."
        expected = r.test_case.expectation.value
        outcome = r.outcome.value.upper()
        lines.append(f"| {prompt} | {expected} | {outcome} |")

    if len(report.results) > 20:
        lines.append(f"| ... | ... | +{len(report.results) - 20} more |")

    lines.extend([
        "",
        "---",
        f"Generated by evals-1337 v0.3.0",
    ])

    with open(path, "w") as f:
        f.write("\n".join(lines))


def export_all(
    report: EvalReport,
    output_dir: Path | str,
    prefix: str | None = None,
) -> dict[str, Path]:
    """Export report to all formats.

    Returns dict mapping format to output path.
    """
    output_dir = Path(output_dir)
    output_dir.mkdir(parents=True, exist_ok=True)

    prefix = prefix or report.name.replace(" ", "-").lower()
    timestamp = datetime.now().strftime("%Y%m%d-%H%M%S")
    base = f"{prefix}-{timestamp}"

    paths = {}

    json_path = output_dir / f"{base}.json"
    export_json(report, json_path)
    paths["json"] = json_path

    csv_path = output_dir / f"{base}.csv"
    export_csv(report, csv_path)
    paths["csv"] = csv_path

    md_path = output_dir / f"{base}.md"
    export_markdown(report, md_path)
    paths["markdown"] = md_path

    return paths
